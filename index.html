<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Par Ops – Inventory + TVA + Sales</title>
  <style>
    :root{
      --bg:#0b1220;
      --text:#e9eefc;
      --muted:#a9b4d6;
      --line:rgba(255,255,255,.08);
      --accent:#7aa2ff;
      --good:#64ffda;
      --warn:#ffd166;
      --bad:#ff6b6b;
      --chip:rgba(122,162,255,.14);
    }
    *{box-sizing:border-box}
    body{margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; background:linear-gradient(180deg,#070b14, #0b1220 35%, #080d18); color:var(--text);}
    .app{display:flex; min-height:100vh;}
    .sidebar{
      width:260px; padding:16px; border-right:1px solid var(--line);
      background: radial-gradient(1200px 600px at 10% 0%, rgba(122,162,255,.18), transparent 55%),
                  radial-gradient(900px 500px at 0% 100%, rgba(100,255,218,.14), transparent 55%),
                  rgba(0,0,0,.12);
    }
    .brand{display:flex; gap:10px; align-items:center; padding:10px 10px 10px;}
    .logo{width:36px;height:36px;border-radius:12px;background:linear-gradient(135deg,var(--accent),#64ffda); box-shadow:0 10px 30px rgba(122,162,255,.25)}
    .brand h1{font-size:16px;margin:0; line-height:1.2}
    .brand .sub{font-size:12px;color:var(--muted)}
    .langRow{display:flex; gap:8px; align-items:center; padding:0 10px 12px;}
    .langRow label{font-size:12px; color:var(--muted)}
    .langRow select{min-width:0; width:110px}
    .nav{display:flex; flex-direction:column; gap:8px; margin-top:8px}
    .nav button{
      width:100%; text-align:left; border:1px solid var(--line); background:rgba(255,255,255,.03);
      color:var(--text); padding:10px 12px; border-radius:14px; cursor:pointer;
      display:flex; justify-content:space-between; align-items:center;
    }
    .nav button.active{border-color:rgba(122,162,255,.6); background:rgba(122,162,255,.12)}
    .chip{font-size:12px;color:var(--muted); background:var(--chip); border:1px solid rgba(122,162,255,.25); padding:3px 8px; border-radius:999px}
    .content{flex:1; padding:14px; max-width:1200px; margin:0 auto; width:100%;}
    .topbar{display:flex; gap:10px; justify-content:space-between; align-items:flex-start; margin-bottom:12px; flex-wrap:wrap}
    .title{font-size:20px; font-weight:800; margin:0}
    .hint{color:var(--muted); font-size:13px}
    .grid{display:grid; grid-template-columns:1fr 1fr; gap:12px}
    @media (max-width: 900px){
      .sidebar{width:220px}
      .grid{grid-template-columns:1fr}
      input, select{min-width:150px}
    }
    @media (max-width: 520px){
      .app{flex-direction:column}
      .sidebar{width:100%; border-right:none; border-bottom:1px solid var(--line)}
      .content{padding:12px}
      .nav{flex-direction:row; flex-wrap:wrap}
      .nav button{width:auto; flex:1 1 calc(50% - 8px)}
    }
    .card{
      border:1px solid var(--line); border-radius:18px; padding:14px;
      background: radial-gradient(900px 450px at 10% 0%, rgba(122,162,255,.12), transparent 55%),
                  rgba(255,255,255,.03);
      box-shadow: 0 18px 60px rgba(0,0,0,.25);
    }
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    input, select, textarea, button{
      border-radius:14px; border:1px solid var(--line); padding:10px 12px;
      background:rgba(0,0,0,.22); color:var(--text);
    }
    input, select{min-width:180px}
    textarea{width:100%; min-height:90px}
    button{cursor:pointer}
    button.primary{background:rgba(122,162,255,.18); border-color:rgba(122,162,255,.45)}
    button.danger{background:rgba(255,107,107,.14); border-color:rgba(255,107,107,.35)}
    table{width:100%; border-collapse:collapse; margin-top:10px}
    th,td{border-bottom:1px solid var(--line); padding:10px; text-align:left; vertical-align:top}
    th{color:var(--muted); font-weight:700; font-size:12px; letter-spacing:.02em}
    .pill{display:inline-block; padding:4px 10px; border-radius:999px; font-size:12px; border:1px solid var(--line); background:rgba(255,255,255,.03)}
    .ok{border-color:rgba(100,255,218,.35); background:rgba(100,255,218,.10)}
    .warn{border-color:rgba(255,209,102,.35); background:rgba(255,209,102,.10)}
    .bad{border-color:rgba(255,107,107,.35); background:rgba(255,107,107,.10)}
    canvas{width:100%; height:260px; border:1px solid var(--line); border-radius:18px; background:rgba(0,0,0,.16)}
    .kpi{font-size:26px; font-weight:900}
    .muted{color:var(--muted)}
    .hidden{display:none}
  </style>
</head>
<body>
<div class="app">
  <aside class="sidebar">
    <div class="brand">
      <div class="logo"></div>
      <div>
        <h1>Par Ops</h1>
        <div class="sub" id="brandSub">Inventory • TVA • Sales</div>
      </div>
    </div>

    <div class="langRow">
      <label id="langLabel" for="langSelect">Language</label>
      <select id="langSelect">
        <option value="en">EN</option>
        <option value="es">ES</option>
      </select>
    </div>

    <div class="nav" id="nav">
      <button data-tab="dash" class="active"><span id="navDash">Dashboard</span> <span class="chip" id="chipToday">$0</span></button>
      <button data-tab="items"><span id="navItems">Items</span> <span class="chip" id="chipItems">0</span></button>
      <button data-tab="receive"><span id="navReceive">Receive</span> <span class="chip" id="chipRcpt">0</span></button>
      <button data-tab="inventory"><span id="navInventory">Inventory</span> <span class="chip" id="chipInv">0</span></button>
      <button data-tab="sales"><span id="navSales">Sales</span> <span class="chip" id="chipSales">0</span></button>
      <button data-tab="tva"><span id="navTva">TVA</span> <span class="chip" id="chipTva">0</span></button>
      <button data-tab="waste"><span id="navWaste">Waste</span> <span class="chip" id="chipWaste">0</span></button>
      <button data-tab="backup"><span id="navBackup">Backup</span> <span class="chip">JSON</span></button>
    </div>
    <div style="height:10px"></div>
    <div class="hint" id="sidebarHint">Runs offline • Saves on this device</div>
  </aside>

  <main class="content">
    <div class="topbar">
      <div>
        <p class="title" id="pageTitle">Dashboard</p>
        <div class="hint" id="pageHint">Today totals + graphs.</div>
      </div>
      <div class="hint" id="topHint">Tip: Export backup weekly</div>
    </div>

    <!-- DASH -->
    <section class="panel" id="dash">
      <div class="grid">
        <div class="card">
          <div class="muted" id="dashRevenueLabel">Today Revenue</div>
          <div class="kpi" id="kpiTodayRevenue">$0.00</div>
          <div class="muted" id="kpiTodayProfit">Today Profit (est): $0.00</div>
        </div>
        <div class="card">
          <div class="muted" id="dashTvaLabel">Today TVA (Actual)</div>
          <div class="kpi" id="kpiTodayTva">$0.00</div>
          <div class="muted" id="kpiTodayMissing">Missing Qty: 0</div>
        </div>
      </div>

      <div class="grid">
        <div class="card">
          <div style="font-weight:800; margin-bottom:8px;" id="chartSalesTitle">Sales ($) by Day</div>
          <canvas id="chartSales" width="900" height="260"></canvas>
        </div>
        <div class="card">
          <div style="font-weight:800; margin-bottom:8px;" id="chartTvaTitle">TVA ($) by Day</div>
          <canvas id="chartTva" width="900" height="260"></canvas>
        </div>
      </div>
    </section>

    <!-- ITEMS -->
    <section class="panel hidden" id="items">
      <div class="card">
        <div style="font-weight:800; margin-bottom:8px;" id="itemsAddTitle">Add / Update Item</div>
        <div class="row">
          <input id="itemSku" placeholder="Item code/SKU (optional)" />
          <input id="itemName" placeholder="Item name" />
          <input id="itemUnit" placeholder="Unit (case, bag, ea)" />
          <input id="itemCost" type="number" step="0.01" min="0" placeholder="Avg unit cost ($)" />
          <input id="itemPar" type="number" step="1" min="0" placeholder="Par level" />
          <input id="itemOnHand" type="number" step="1" min="0" placeholder="On-hand" />
<button class="primary" id="saveItemBtn">Save Item</button>
        </div>
        <div class="hint" style="margin-top:8px;" id="itemsAddHint">
          Tip: cost is average cost. Receiving can update cost automatically if you enter unit cost on the receipt line.
        </div>
      </div>

      <div class="card">
        <div style="font-weight:800; margin-bottom:8px;" id="itemsTableTitle">Items</div>
        <table>
          <thead>
            <tr>
              <th id="thItem">Item</th><th id="thSku">SKU</th><th id="thCost">Avg Cost</th><th id="thPar">Par</th>
              <th id="thOnHand">On-hand</th><th id="thExp">Next Exp</th><th id="thStatus">Status</th><th id="thActions">Actions</th>
            </tr>
          </thead>
          <tbody id="itemsTbody"></tbody>
        </table>
      </div>
    </section>

    <!-- RECEIVE -->
    <section class="panel hidden" id="receive">
      <div class="card">
        <div style="font-weight:800; margin-bottom:8px;" id="rcptTitle">New Delivery</div>
        <div class="row">
          <input id="rcptCode" placeholder="Receipt / Invoice code" />
          <input id="rcptDate" type="date" />
          <button class="primary" id="startRcptBtn">Start / Load</button>
          <button class="primary" id="finalizeRcptBtn">Finalize (update inventory + log TVA)</button>
        </div>
        <div class="hint" style="margin-top:8px;" id="rcptHint">Start → add lines → Finalize.</div>
      </div>

      <div class="card">
        <div style="font-weight:800; margin-bottom:8px;" id="linesAddTitle">Add Lines</div>
        <div class="row">
          <select id="lineItemSelect"></select>
          <input id="lineExpected" type="number" min="0" step="1" placeholder="Expected qty" />
          <input id="lineReceived" type="number" min="0" step="1" placeholder="Received qty" />
          <input id="lineUnitCost" type="number" min="0" step="0.01" placeholder="Unit cost (this receipt)" />
          
          <input id="lineExp" type="date" />
<button class="primary" id="addLineBtn">Add Line</button>
        </div>

        <div class="hint" style="margin-top:10px;" id="bulkHint">
          Paste format: <span class="pill">Item Name, Expected, Received, UnitCost, ExpDate</span> (UnitCost & ExpDate optional)
        </div>
        <textarea id="bulkPaste" placeholder="Coke, 10, 10, 0.80&#10;Napkins, 2, 1&#10;Sauce, 5, 5, 0.12"></textarea>
        <div class="row" style="margin-top:8px;">
          <button class="primary" id="bulkImportBtn">Import Lines</button>
          <button class="danger" id="clearLinesBtn">Clear Lines</button>
        </div>
      </div>

      <div class="card">
        <div style="font-weight:800; margin-bottom:8px;" id="rcptLinesTitle">Receipt Lines</div>
        <table>
          <thead>
            <tr>
              <th id="thRItem">Item</th><th id="thRExpDate">Exp Date</th><th id="thRExp">Expected</th><th id="thRRec">Received</th><th id="thRCost">Unit Cost</th>
              <th id="thRDiff">Diff</th><th id="thRMissD">Missing $</th><th id="thRStatus">Status</th><th id="thRAction">Action</th>
            </tr>
          </thead>
          <tbody id="linesTbody"></tbody>
        </table>
        <div class="hint" id="rcptSummary"></div>
      </div>
    </section>
    <!-- INVENTORY -->
    <section class="panel hidden" id="inventory">
      <div class="card">
        <div style="font-weight:800; margin-bottom:8px;" id="invTitle">Inventory</div>
        <div class="row">
          <input id="invSearch" placeholder="Search item..." />
          <div class="spacer"></div>
          <div class="hint" id="invHint">Totals across all deliveries (batches).</div>
        </div>
        <div class="tableWrap">
          <table class="table" id="invTable">
            <thead>
              <tr>
                <th id="invThItem">Item</th>
                <th id="invThQty">Total Qty</th>
                <th id="invThUnit">Unit</th>
                <th id="invThAvgCost">Avg Cost</th>
                <th id="invThValue">Total Value</th>
                <th id="invThNextExp">Next Exp</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>


    <!-- SALES -->
    <section class="panel hidden" id="sales">
      <div class="card">
        <div style="font-weight:800; margin-bottom:8px;" id="salesTitle">Record Sale</div>
        <div class="row">
          <input id="sDate" type="date" />
          <select id="saleItemSelect"></select>
          <input id="sQty" type="number" min="1" step="1" placeholder="Qty sold" />
          <input id="sPrice" type="number" min="0" step="0.01" placeholder="Sell price (per unit)" />
          <button class="primary" id="addSaleBtn">Add Sale</button>
        </div>
        <div class="hint" style="margin-top:8px;" id="salesHint">
          This auto-subtracts inventory (On-hand) and logs revenue + estimated profit.
        </div>
      </div>

      <div class="grid">
        <div class="card">
          <div class="muted" id="salesTodayLabel">Today Revenue</div>
          <div class="kpi" id="salesTodayRevenue">$0.00</div>
          <div class="muted" id="salesTodayProfit">Today Profit (est): $0.00</div>
        </div>
        <div class="card">
          <div style="font-weight:800; margin-bottom:8px;" id="salesChartTitle">Sales ($) by Day</div>
          <canvas id="chartSales2" width="900" height="260"></canvas>
        </div>
      </div>

      <div class="card">
        <div style="font-weight:800; margin-bottom:8px;" id="salesLogTitle">Sales Log</div>
        <table>
          <thead>
            <tr>
              <th id="thSDate">Date</th><th id="thSItem">Item</th><th id="thSQty">Qty</th><th id="thSPrice">Price</th>
              <th id="thSRev">Revenue</th><th id="thSCogs">Cost</th><th id="thSProf">Profit</th><th id="thSAct">Action</th>
            </tr>
          </thead>
          <tbody id="salesTbody"></tbody>
        </table>
      </div>
    </section>

    <!-- TVA -->
    <section class="panel hidden" id="tva">
      <div class="grid">
        <div class="card">
          <div style="font-weight:800; margin-bottom:8px;" id="tvaControlsTitle">TVA Controls</div>
          <div class="row">
            <input id="tvaTarget" type="number" step="0.01" min="0" placeholder="Daily TVA Target ($)" />
            <button class="primary" id="saveTargetBtn">Save Target</button>
          </div>
          <div class="hint" style="margin-top:8px;" id="tvaControlsHint">Target is per-day. Actual is from finalized receipts.</div>
          <div style="height:10px"></div>
          <div class="muted" id="tvaTodayLabel">Today</div>
          <div class="kpi" id="tvaActualKpi">$0.00</div>
          <div class="row">
            <span class="pill" id="tvaTargetPill">Target: $0.00</span>
            <span class="pill" id="tvaVarPill">Variance: $0.00</span>
            <span class="pill" id="tvaEffPill">Efficiency: 100%</span>
          </div>
        </div>

        <div class="card">
          <div style="font-weight:800; margin-bottom:8px;" id="tvaChartTitle">TVA Actual vs Target</div>
          <canvas id="chartTarget" width="900" height="260"></canvas>
        </div>
      </div>

      <div class="card">
        <div style="font-weight:800; margin-bottom:8px;" id="tvaLogTitle">TVA Log</div>
        <table>
          <thead><tr><th id="thTDate">Date</th><th id="thTReceipt">Receipt</th><th id="thTMissQ">Missing Qty</th><th id="thTTva">TVA ($)</th></tr></thead>
          <tbody id="tvaTbody"></tbody>
        </table>
      </div>
    </section>

    <!-- WASTE -->
    <section class="panel hidden" id="waste">
      <div class="card">
        <div style="font-weight:800; margin-bottom:8px;" id="wasteLogTitle">Log Waste</div>
        <div class="row">
          <input id="wDate" type="date" />
          <input id="wItem" placeholder="Waste item (e.g., Chicken, Fries)" />
          <input id="wQty" type="number" step="1" min="0" placeholder="Qty" />
          <input id="wCost" type="number" step="0.01" min="0" placeholder="Cost ($) (optional)" />
          <input id="wReason" placeholder="Reason (hold time, drop, mistake)" />
          <button class="primary" id="addWasteBtn">Add</button>
        </div>
        <div class="hint" style="margin-top:8px;" id="wasteHint">If cost is blank, it logs $0 (still tracks qty).</div>
      </div>

      <div class="grid">
        <div class="card">
          <div style="font-weight:800; margin-bottom:8px;" id="wasteChartTitle">Waste ($) by Day</div>
          <canvas id="chartWaste" width="900" height="260"></canvas>
        </div>
        <div class="card">
          <div class="muted" id="wasteTodayLabel">Today Waste ($)</div>
          <div class="kpi" id="wasteToday">$0.00</div>
          <div class="muted" id="wasteTodayQty">Qty: 0</div>
        </div>
      </div>

      <div class="card">
        <div style="font-weight:800; margin-bottom:8px;" id="wasteTableTitle">Waste Log</div>
        <table>
          <thead><tr><th id="thWDate">Date</th><th id="thWItem">Item</th><th id="thWQty">Qty</th><th id="thWCost">$</th><th id="thWReason">Reason</th><th id="thWAction">Action</th></tr></thead>
          <tbody id="wasteTbody"></tbody>
        </table>
      </div>
    </section>

    <!-- BACKUP -->
    <section class="panel hidden" id="backup">
      <div class="card">
        <div style="font-weight:800; margin-bottom:8px;" id="backupTitle">Backup / Restore</div>
        <div class="row">
          <button class="primary" id="exportBtn">Export JSON</button>
          <button class="primary" id="importBtn">Import JSON</button>
          <input id="importFile" type="file" accept="application/json" class="hidden" />
          <button class="danger" id="wipeBtn">Wipe All Data</button>
        </div>
        <div class="hint" style="margin-top:8px;" id="backupHint">Export weekly so you never lose it.</div>
      </div>
    </section>

  </main>
</div>

<script>
  const KEY = "par_ops_v3_sales";
  const LANG_KEY = "par_ops_lang";

  const I18N = {
    en: {
      language:"Language",
      brandSub:"Inventory • TVA • Sales",
      sidebarHint:"Runs offline • Saves on this device",
      topHint:"Tip: Export backup weekly",
      nav:{dash:"Dashboard", items:"Items", receive:"Receive", sales:"Sales", tva:"TVA", waste:"Waste", backup:"Backup", inventory:"Inventory"},
      page:{
        dash:{title:"Dashboard", hint:"Today totals + graphs."},
        items:{title:"Items", hint:"Track on-hand, par, expiration."},
        receive:{title:"Receive", hint:"Receipt lines + costs + finalize."},
        sales:{title:"Sales", hint:"Log sales → auto subtract inventory."},
        tva:{title:"TVA", hint:"Targets + variance + efficiency."},
        waste:{title:"Waste", hint:"Waste log + daily totals."},
        backup:{title:"Backup", hint:"Export/Import JSON."}
      }
    },
    es: {
      language:"Idioma",
      brandSub:"Inventario • TVA • Ventas",
      sidebarHint:"Funciona sin internet • Guarda en este dispositivo",
      topHint:"Tip: Exporta el respaldo cada semana",
      nav:{dash:"Panel", items:"Artículos", receive:"Recepción", sales:"Ventas", tva:"TVA", waste:"Merma", backup:"Respaldo", inventory:"Inventario"},
      page:{
        dash:{title:"Panel", hint:"Totales de hoy + gráficas."},
        items:{title:"Artículos", hint:"En mano, par, caducidad."},
        receive:{title:"Recepción", hint:"Líneas + costos + finalizar."},
        sales:{title:"Ventas", hint:"Registra ventas → resta inventario."},
        tva:{title:"TVA", hint:"Metas + variación + eficiencia."},
        waste:{title:"Merma", hint:"Historial + totales diarios."},
        inventory:{title:"Inventario", hint:"Totales de todas las entregas (lotes)."},
        backup:{title:"Respaldo", hint:"Exportar/Importar JSON."}
      }
    }
  };

  let lang = localStorage.getItem(LANG_KEY) || "en";
  function L(){ return I18N[lang] || I18N.en; }

  function defaultDB(){
    return {
      items: [],
      receipts: [],
      tvaLog: [],
      tvaTargetByDate: {},
      waste: [],
      sales: []
    ,
      batches: []
    };
  }
function loadDB(){
    try{ const raw = localStorage.getItem(KEY); return raw ? JSON.parse(raw) : defaultDB(); }
    catch{ return defaultDB(); }
  }
  function saveDB(){ localStorage.setItem(KEY, JSON.stringify(db)); }

  const $ = (id)=>document.getElementById(id);
  const todayISO = ()=> new Date().toISOString().slice(0,10);
  $("rcptDate").value = todayISO();
  $("wDate").value = todayISO();
  $("sDate").value = todayISO();

  function uid(){ return Math.random().toString(16).slice(2) + "-" + Date.now().toString(16); }
  function num(n){ return Number(n||0); }
  function money(n){ return (num(n)).toLocaleString(undefined,{style:"currency",currency:"USD"}); }
  function fmtQty(n){
    const v = num(n);
    // show up to 3 decimals but trim trailing zeros
    const s = v.toFixed(3).replace(/\.?(0+)$/,"");
    return s;
  }
  function esc(s){
    return String(s ?? "").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
      .replaceAll('"',"&quot;").replaceAll("'","&#039;");
  }

  // EXPIRATION
  function daysUntil(dateStr){
    if(!dateStr) return null;
    const today = new Date(todayISO() + "T00:00:00");
    const d = new Date(dateStr + "T00:00:00");
    return Math.floor((d - today) / (1000*60*60*24));
  }
  function expirationPill(expDate){
    if(!expDate) return { cls:"pill", text:"—", isExpired:false };
    const d = daysUntil(expDate);
    if(d < 0) return { cls:"pill bad", text:(lang==="es"?`CADUCADO (${expDate})`:`EXPIRED (${expDate})`), isExpired:true };
    if(d <= 3) return { cls:"pill warn", text:(lang==="es"?`Pronto (${d}d)`:`Soon (${d}d)`), isExpired:false };
    return { cls:"pill ok", text:expDate, isExpired:false };
  }


  // BATCH / LOT INVENTORY (per-delivery expiration + cost)
  function normDate(d){ return d ? String(d) : ""; }
  function batchSortKey(b){
    const rd = normDate(b.receivedDate) || "9999-12-31";
    const ed = normDate(b.expDate) || "9999-12-31";
    return rd + "|" + ed;
  }
  function availableQty(itemId){
    if(!Array.isArray(db.batches) || db.batches.length===0){
      const it = db.items.find(x=>x.id===itemId);
      return it ? num(it.onHand) : 0;
    }
    return db.batches.filter(b=>b.itemId===itemId).reduce((s,b)=>s+num(b.qtyRemaining),0);
  }
  function recomputeItemOnHand(itemId){
    const it = db.items.find(x=>x.id===itemId);
    if(!it) return;
    it.onHand = Math.max(0, availableQty(itemId));
  }
  
  function recomputeAvgCostFromBatches(itemId){
    const it = db.items.find(x=>x.id===itemId);
    if(!it) return;
    if(!Array.isArray(db.batches) || db.batches.length===0) return;
    let qty=0, value=0;
    for(const b of db.batches){
      if(b.itemId!==itemId) continue;
      const q = Math.max(0, num(b.qtyRemaining));
      if(q<=0) continue;
      qty += q;
      value += q * Math.max(0, num(b.unitCost));
    }
    if(qty>0){
      const avg = value/qty;
      if(Number.isFinite(avg)) it.cost = avg;
    }
  }

  function batchIdForLine(receiptCode, lineId){
    return `rcpt:${receiptCode}:${lineId}`;
  }

  function syncReceiptLineToBatch(receipt, line){
    const it = db.items.find(x=>x.id===line.itemId);
    if(!it) return;

    if(!line.id) line.id = uid();
    const received = Math.max(0, num(line.received));
    const expDate = String(line.expDate||"").trim();
    const unitCost = (num(line.unitCost)>0) ? num(line.unitCost) : num(it.cost);

    const bid = batchIdForLine(receipt.code, line.id);
    let b = (db.batches||[]).find(x=>x.id===bid);

    if(received<=0){
      if(b){
        const idx = db.batches.findIndex(x=>x.id===bid);
        if(idx>=0) db.batches.splice(idx,1);
        recomputeItemOnHand(it.id);
        recomputeAvgCostFromBatches(it.id);
      }
      return;
    }

    if(!b){
      b = {
        id: bid,
        itemId: it.id,
        itemName: it.name,
        receiptCode: receipt.code,
        receivedDate: receipt.date || todayISO(),
        expDate,
        qty: received,
        qtyRemaining: received,
        unitCost: Math.max(0, unitCost)
      };
      db.batches.unshift(b);
    } else {
      const consumed = Math.max(0, num(b.qty) - num(b.qtyRemaining));
      b.receivedDate = receipt.date || b.receivedDate || todayISO();
      b.expDate = expDate;
      b.unitCost = Math.max(0, unitCost);
      b.qty = received;
      b.qtyRemaining = Math.max(0, received - consumed);
    }

    recomputeItemOnHand(it.id);
    recomputeAvgCostFromBatches(it.id);
  }

  function removeBatchForReceiptLine(receiptCode, lineId){
    const bid = batchIdForLine(receiptCode, lineId);
    const idx = (db.batches||[]).findIndex(x=>x.id===bid);
    if(idx>=0){
      const itemId = db.batches[idx].itemId;
      db.batches.splice(idx,1);
      recomputeItemOnHand(itemId);
      recomputeAvgCostFromBatches(itemId);
    }
  }

  function nextExpForItem(itemId){
    const batches = (db.batches||[]).filter(b=>b.itemId===itemId && num(b.qtyRemaining)>0 && b.expDate);
    if(batches.length===0) return "";
    batches.sort((a,b)=> (normDate(a.expDate)||"9999-12-31").localeCompare(normDate(b.expDate)||"9999-12-31"));
    return normDate(batches[0].expDate);
  }
  function consumeFromBatches(itemId, qty){
    qty = Math.max(0, num(qty));
    if(qty<=0) return { ok:true, qtyTaken:0, totalCost:0 };

    // If no batches exist (old data), fall back to item-level onHand/cost.
    if(!Array.isArray(db.batches) || db.batches.length===0){
      const it = db.items.find(x=>x.id===itemId);
      const have = it ? num(it.onHand) : 0;
      if(have < qty) return { ok:false, qtyTaken:0, totalCost:0 };
      const cost = it ? num(it.cost) : 0;
      if(it) it.onHand = Math.max(0, have - qty);
      return { ok:true, qtyTaken:qty, totalCost: qty * cost };
    }

    const batches = db.batches
      .filter(b=>b.itemId===itemId && num(b.qtyRemaining)>0)
      .sort((a,b)=>batchSortKey(a).localeCompare(batchSortKey(b)));

    let remaining = qty;
    let totalCost = 0;
    const touched = [];
    for(const b of batches){
      if(remaining<=0) break;
      const take = Math.min(num(b.qtyRemaining), remaining);
      if(take<=0) continue;
      touched.push([b, take]);
      remaining -= take;
    }
    if(remaining>0) return { ok:false, qtyTaken:0, totalCost:0 };

    // Commit consumption
    for(const [b,take] of touched){
      b.qtyRemaining = Math.max(0, num(b.qtyRemaining) - take);
      totalCost += take * Math.max(0, num(b.unitCost));
    }
    recomputeItemOnHand(itemId);
    return { ok:true, qtyTaken:qty, totalCost };
  }

  // NAV
  let currentTab = "dash";
  document.getElementById("nav").addEventListener("click",(e)=>{
    const btn = e.target.closest("button[data-tab]");
    if(!btn) return;
    const tab = btn.dataset.tab;
    currentTab = tab;
    document.querySelectorAll(".nav button").forEach(b=>b.classList.remove("active"));
    btn.classList.add("active");
    document.querySelectorAll(".panel").forEach(p=>p.classList.add("hidden"));
    document.getElementById(tab).classList.remove("hidden");
    applyLang();
    renderAll();
  });

  $("langSelect").addEventListener("change", ()=>{
    lang = $("langSelect").value;
    localStorage.setItem(LANG_KEY, lang);
    applyLang();
    renderAll();
  });
  $("invSearch")?.addEventListener("input", ()=>{ renderInventory(); });


  function applyLang(){
    $("langSelect").value = lang;
    $("langLabel").textContent = L().language;
    $("brandSub").textContent = L().brandSub;
    $("sidebarHint").textContent = L().sidebarHint;
    $("topHint").textContent = L().topHint;

    $("navDash").textContent = L().nav.dash;
    $("navItems").textContent = L().nav.items;
    $("navReceive").textContent = L().nav.receive;
    $("navInventory").textContent = L().nav.inventory;
    $("navSales").textContent = L().nav.sales;
    $("navTva").textContent = L().nav.tva;
    $("navWaste").textContent = L().nav.waste;
    $("navBackup").textContent = L().nav.backup;

    $("pageTitle").textContent = L().page[currentTab].title;
    $("pageHint").textContent = L().page[currentTab].hint;
  }

  // DB
  let db = loadDB();
  // migrations
  if(!db.batches) db.batches = [];
// ITEMS
  $("saveItemBtn").addEventListener("click", ()=>{
    const sku = $("itemSku").value.trim();
    const name = $("itemName").value.trim();
    const unit = $("itemUnit").value.trim();
    const cost = Math.max(0, num($("itemCost").value));
    const par = Math.max(0, num($("itemPar").value));
    const onHand = Math.max(0, num($("itemOnHand").value));
if(!name){ alert(lang==="es"?"Se requiere nombre.":"Item name required."); return; }

    let it = null;
    if(sku) it = db.items.find(x=> (x.sku||"").toLowerCase()===sku.toLowerCase());
    if(!it) it = db.items.find(x=> x.name.toLowerCase()===name.toLowerCase());

    if(!it){
      it = { id: uid(), sku, name, unit, cost, par, onHand };
      db.items.push(it);
    }else{
      it.sku = sku || it.sku;
      it.name = name;
      it.unit = unit;
      it.cost = cost;
      it.par = par;
      it.onHand = onHand;
}

    saveDB();
    $("itemSku").value = $("itemName").value = $("itemUnit").value = "";
    $("itemCost").value = $("itemPar").value = $("itemOnHand").value = "";
renderAll();
  });

  function itemStatus(it){
    const onHand = availableQty(it.id);
    if(onHand < num(it.par)) return { label:(lang==="es"?"Bajo Par":"Below Par"), cls:"bad" };
    if(onHand === num(it.par)) return { label:(lang==="es"?"En Par":"At Par"), cls:"warn" };
    return { label:"OK", cls:"ok" };
  }

  function renderItems(){
    const tb = $("itemsTbody");
    tb.innerHTML = "";
    const items = [...db.items].sort((a,b)=>a.name.localeCompare(b.name));
    for(const it of items){
      const st = itemStatus(it);
      const expPill = expirationPill(nextExpForItem(it.id));

      const tr = document.createElement("tr");
      if(expPill.isExpired) tr.style.background = "rgba(255,107,107,.08)";
      tr.innerHTML = `
        <td>${esc(it.name)}</td>
        <td>${esc(it.sku||"")}</td>
        <td>${money(it.cost)}</td>
        <td>${num(it.par)}</td>
        <td>${fmtQty(availableQty(it.id))}</td>
        <td><span class="${expPill.cls}">${esc(expPill.text)}</span></td>
        <td><span class="pill ${st.cls}">${st.label}</span></td>
        <td>
          <button data-act="edit" data-id="${it.id}" class="primary">${lang==="es"?"Editar":"Edit"}</button>
          <button data-act="del" data-id="${it.id}" class="danger">${lang==="es"?"Borrar":"Delete"}</button>
        </td>`;
      tb.appendChild(tr);
    }

    tb.onclick = (e)=>{
      const btn = e.target.closest("button"); if(!btn) return;
      const id = btn.dataset.id;
      const act = btn.dataset.act;
      const idx = db.items.findIndex(x=>x.id===id); if(idx<0) return;

      if(act==="del"){
        if(!confirm(lang==="es"?"¿Borrar artículo?":"Delete item?")) return;
        db.items.splice(idx,1);
        db.receipts.forEach(r=> r.lines = (r.lines||[]).filter(l=>l.itemId!==id));
        saveDB(); renderAll(); return;
      }
      if(act==="edit"){
        const it = db.items[idx];
        $("itemSku").value = it.sku||"";
        $("itemName").value = it.name||"";
        $("itemUnit").value = it.unit||"";
        $("itemCost").value = it.cost ?? 0;
        $("itemPar").value = it.par ?? 0;
        $("itemOnHand").value = availableQty(it.id);
alert(lang==="es"?"Edita y presiona Guardar.":"Edit fields then press Save Item.");
      }
    };
  }

  function renderItemSelects(){
    const items = [...db.items].sort((a,b)=>a.name.localeCompare(b.name));
    const sel1 = $("lineItemSelect");
    const sel2 = $("saleItemSelect");
    sel1.innerHTML = ""; sel2.innerHTML = "";
    for(const it of items){
      const opt1 = document.createElement("option");
      opt1.value = it.id;
      opt1.textContent = it.sku ? `${it.name} (${it.sku})` : it.name;
      sel1.appendChild(opt1);

      const opt2 = document.createElement("option");
      opt2.value = it.id;
      opt2.textContent = it.sku ? `${it.name} (${it.sku})` : it.name;
      sel2.appendChild(opt2);
    }
  }

  // RECEIPTS
  let activeCode = "";

  $("startRcptBtn").addEventListener("click", ()=>{
    const code = $("rcptCode").value.trim();
    const date = $("rcptDate").value || todayISO();
    if(!code){ alert(lang==="es"?"Ingresa código del recibo.":"Enter receipt/invoice code."); return; }

    let r = db.receipts.find(x=>x.code===code);
    if(!r){ r = { code, date, lines: [] }; db.receipts.unshift(r); }
    else r.date = date;

    activeCode = code;
    saveDB(); renderAll();
  });

  $("addLineBtn").addEventListener("click", ()=>{
    if(!activeCode){ alert(lang==="es"?"Primero inicia un recibo.":"Start a receipt first."); return; }
    const r = db.receipts.find(x=>x.code===activeCode); if(!r) return;

    const itemId = $("lineItemSelect").value;
    const expected = Math.max(0, num($("lineExpected").value));
    const received = Math.max(0, num($("lineReceived").value));
    const unitCost = Math.max(0, num($("lineUnitCost").value)); // optional
    const expDate = $("lineExp").value || "";
    if(!itemId){ alert(lang==="es"?"Elige un artículo.":"Pick an item."); return; }

    const ex = r.lines.find(l=>
      l.itemId===itemId &&
      String(l.expDate||"")===(expDate||"") &&
      num(l.unitCost||0)===num(unitCost||0)
    );

    if(ex){
      if(!ex.id) ex.id = uid();
      ex.expected += expected;
      ex.received += received;
      ex.expDate = expDate || ex.expDate || "";
      if(unitCost>0) ex.unitCost = unitCost;
      syncReceiptLineToBatch(r, ex);
    } else {
      const line = { id: uid(), itemId, expDate, expected, received, unitCost: unitCost>0?unitCost:0 };
      r.lines.push(line);
      syncReceiptLineToBatch(r, line);
    }

    $("lineExpected").value = ""; $("lineReceived").value = ""; $("lineUnitCost").value = ""; $("lineExp").value = "";
    saveDB(); renderAll();
  });

  $("bulkImportBtn").addEventListener("click", ()=>{
    if(!activeCode){ alert(lang==="es"?"Primero inicia un recibo.":"Start a receipt first."); return; }
    const r = db.receipts.find(x=>x.code===activeCode); if(!r) return;

    const text = $("bulkPaste").value.trim(); if(!text) return;
    const rows = text.split(/\r?\n/).map(x=>x.trim()).filter(Boolean);
    let added=0;

    for(const row of rows){
      const parts = row.split(",").map(x=>x.trim());
      if(parts.length<2) continue;
      const name = parts[0];
      const expected = Math.max(0, num(parts[1]));
      const received = Math.max(0, num(parts[2] ?? parts[1]));
      let unitCost = 0;
      let expDate = "";
      const p3 = (parts[3] ?? "").trim();
      const p4 = (parts[4] ?? "").trim();
      const looksDate = (s)=>/^\d{4}-\d{2}-\d{2}$/.test(s);
      if(p3){
        if(looksDate(p3)) expDate = p3;
        else unitCost = Math.max(0, num(p3));
      }
      if(p4){
        if(looksDate(p4)) expDate = p4;
      }

      let it = db.items.find(x=>x.name.toLowerCase()===name.toLowerCase());
      if(!it){
        it = { id: uid(), sku:"", name, unit:"", cost:0, par:0, onHand:0 };
        db.items.push(it);
      }

      const ex = r.lines.find(l=>
        l.itemId===it.id &&
        String(l.expDate||"")===(expDate||"") &&
        num(l.unitCost||0)===num(unitCost||0)
      );

      if(ex){
        if(!ex.id) ex.id = uid();
        ex.expected += expected;
        ex.received += received;
        if(unitCost>0) ex.unitCost = unitCost;
        if(expDate) ex.expDate = expDate;
        syncReceiptLineToBatch(r, ex);
      } else {
        const line = { id: uid(), itemId: it.id, expDate, expected, received, unitCost: unitCost>0?unitCost:0 };
        r.lines.push(line);
        syncReceiptLineToBatch(r, line);
      }

      added++;
    }

    $("bulkPaste").value="";
    saveDB(); renderAll();
    alert(lang==="es"?`Se importaron ${added} líneas.`:`Imported ${added} lines.`);
  });

  $("clearLinesBtn").addEventListener("click", ()=>{
    if(!activeCode) return;
    const r = db.receipts.find(x=>x.code===activeCode); if(!r) return;
    if(!confirm(lang==="es"?"¿Borrar todas las líneas?":"Clear all lines?")) return;
    for(const l of (r.lines||[])) if(l.id) removeBatchForReceiptLine(r.code, l.id);
    r.lines=[]; saveDB(); renderAll();
  });

  function lineStatus(exp, rec){
    if(rec===exp) return {label:"OK", cls:"ok"};
    if(rec>exp) return {label:(lang==="es"?"Extra":"Extra"), cls:"warn"};
    return {label:(lang==="es"?"Falta":"Missing"), cls:"bad"};
  }

  $("finalizeRcptBtn").addEventListener("click", ()=>{
    if(!activeCode){ alert(lang==="es"?"Primero inicia un recibo.":"Start a receipt first."); return; }
    const r = db.receipts.find(x=>x.code===activeCode); if(!r) return;

    let missingQty=0, tvaDollars=0;

    for(const l of (r.lines||[])){
      if(!l.id) l.id = uid();
      const it = db.items.find(x=>x.id===l.itemId);
      if(!it) continue;

      // ensure batch exists/updated for this line
      syncReceiptLineToBatch(r, l);

      const exp = Math.max(0, num(l.expected));
      const rec = Math.max(0, num(l.received));
      const receiptCost = (num(l.unitCost)>0) ? num(l.unitCost) : num(it.cost);

      if(rec < exp){
        const miss = exp - rec;
        missingQty += miss;
        tvaDollars += miss * receiptCost;
      }
    }

    const date = r.date || todayISO();
    db.tvaLog.unshift({ date, code: r.code, missingQty, tvaDollars });
    saveDB(); renderAll();
    alert((lang==="es"?"Finalizado.\nFaltante: ":"Finalized.\nMissing Qty: ") + missingQty + "\nTVA: " + money(tvaDollars));
  });

  function renderReceipt(){
    const tb = $("linesTbody"); tb.innerHTML="";
    const code = $("rcptCode").value.trim();
    const r = db.receipts.find(x=>x.code===code);
    activeCode = r ? r.code : "";

    if(!r){ $("rcptSummary").textContent = (lang==="es" ? "Inicia un recibo para agregar líneas." : "Start a receipt code to add lines."); return; }
    $("rcptDate").value = r.date || todayISO();

    const sorted=[...(r.lines||[])].sort((a,b)=>{
      const an = db.items.find(x=>x.id===a.itemId)?.name || "";
      const bn = db.items.find(x=>x.id===b.itemId)?.name || "";
      return an.localeCompare(bn);
    });

    let missQty=0, miss$=0;
    for(const l of sorted){
      if(!l.id) l.id = uid();
      const it = db.items.find(x=>x.id===l.itemId);
      const name = it ? it.name : "(deleted)";
      const exp = Math.max(0,num(l.expected));
      const rec = Math.max(0,num(l.received));
      const uCost = num(l.unitCost) > 0 ? num(l.unitCost) : num(it?.cost||0);
      const diff = rec-exp;
      const missing = exp>rec ? (exp-rec) : 0;
      const missingDollars = missing * uCost;
      const st = lineStatus(exp,rec);
      missQty += missing; miss$ += missingDollars;

      const tr=document.createElement("tr");
      tr.innerHTML = `
        <td>${esc(name)}</td><td>${esc(l.expDate||"")}</td><td>${exp}</td><td>${rec}</td><td>${uCost ? money(uCost) : "$0.00"}</td>
        <td>${diff}</td>
        <td>${money(missingDollars)}</td>
        <td><span class="pill ${st.cls}">${st.label}</span></td>
        <td>
          <button class="primary" data-act="edit" data-line="${l.id}">${lang==="es"?"Editar":"Edit"}</button>
          <button class="danger" data-act="del" data-line="${l.id}">${lang==="es"?"Borrar":"Delete"}</button>
        </td>`;
      tb.appendChild(tr);
    }

    $("rcptSummary").textContent =
      (lang==="es"
        ? `Recibo ${r.code} (${r.date}): Faltante ${missQty} • TVA ${money(miss$)}`
        : `Receipt ${r.code} (${r.date}): Missing Qty ${missQty} • TVA ${money(miss$)}`);

    tb.onclick=(e)=>{
      const btn = e.target.closest("button"); if(!btn) return;
      const act = btn.dataset.act;
      const lineId = btn.dataset.line;
      const idx = r.lines.findIndex(x=>x.id===lineId);
      if(idx<0) return;
if(act==="del"){
        if(!confirm(lang==="es"?"¿Borrar esta línea?":"Delete this line?")) return;
        const dead = r.lines[idx]; if(dead && dead.id) removeBatchForReceiptLine(r.code, dead.id);
        r.lines.splice(idx,1); saveDB(); renderAll();
      }
      if(act==="edit"){
        const cur=r.lines[idx];
        const exp=prompt(lang==="es"?"Cant. esperada:":"Expected qty:", String(cur.expected)); if(exp===null) return;
        const rec=prompt(lang==="es"?"Cant. recibida:":"Received qty:", String(cur.received)); if(rec===null) return;
        const uc=prompt(lang==="es"?"Costo unitario (opcional):":"Unit cost (optional):", String(cur.unitCost||0)); if(uc===null) return;
        const ed=prompt(lang==="es"?"Caducidad (AAAA-MM-DD, opcional):":"Exp date (YYYY-MM-DD, optional):", String(cur.expDate||"")); if(ed===null) return;
        cur.expected=Math.max(0,num(exp));
        cur.received=Math.max(0,num(rec));
        cur.unitCost=Math.max(0,num(uc));
        cur.expDate = String(ed||"").trim();
        syncReceiptLineToBatch(r, cur);
        saveDB(); renderAll();
      }
    };
  }

  // SALES
  $("addSaleBtn").addEventListener("click", ()=>{
    const date = $("sDate").value || todayISO();
    const itemId = $("saleItemSelect").value;
    const qty = Math.max(0, num($("sQty").value));
    const price = Math.max(0, num($("sPrice").value));
    if(!itemId){ alert(lang==="es"?"Elige un artículo.":"Pick an item."); return; }
    if(qty <= 0){ alert(lang==="es"?"Cantidad inválida.":"Invalid qty."); return; }

    const it = db.items.find(x=>x.id===itemId);
    if(!it){ alert(lang==="es"?"Artículo no existe.":"Item not found."); return; }

    // consume from delivery batches (FIFO) so different deliveries/prices/expirations are tracked
    const have = availableQty(itemId);
    if(have < qty){
      alert(lang==="es"
        ? `No hay suficiente inventario. En mano: ${have}`
        : `Not enough inventory. On-hand: ${have}`);
      return;
    }

    const take = consumeFromBatches(itemId, qty);
    if(!take.ok){
      alert(lang==="es"?"No hay suficiente inventario.":"Not enough inventory.");
      return;
    }

    const revenue = qty * price;
    const cogs = take.totalCost;
    const cogsPerUnit = qty>0 ? (cogs / qty) : 0;
    const profit = revenue - cogs;

    // keep item.onHand in sync (consumeFromBatches already recomputes when batches exist)
    if(!Array.isArray(db.batches) || db.batches.length===0){
      it.onHand = Math.max(0, num(it.onHand) - qty);
    }
db.sales.unshift({
      id: uid(),
      date,
      itemId,
      itemName: it.name,
      qty,
      price,
      revenue,
      cogsPerUnit,
      cogs,
      profit
    });

    $("sQty").value = "";
    $("sPrice").value = "";
    saveDB();
    renderAll();
  });

  
  function inventoryTotals(){
    const rows = [];
    const byItem = new Map();
    const hasBatches = Array.isArray(db.batches) && db.batches.length>0;

    for(const it of db.items){
      byItem.set(it.id, { item: it, qty:0, value:0, costQty:0, nextExp:"" });
    }

    if(hasBatches){
      for(const b of db.batches){
        if(!byItem.has(b.itemId)) continue;
        const rec = byItem.get(b.itemId);
        const q = Math.max(0, num(b.qtyRemaining));
        if(q<=0) continue;
        const c = Math.max(0, num(b.unitCost));
        rec.qty += q;
        rec.value += q*c;
        rec.costQty += q;
        if(b.expDate){
          const d = normDate(b.expDate);
          if(d && (!rec.nextExp || d < rec.nextExp)) rec.nextExp = d;
        }
      }
    } else {
      // fallback: use item.onHand and item.cost if batches don't exist
      for(const it of db.items){
        const rec = byItem.get(it.id);
        const q = Math.max(0, num(it.onHand));
        const c = Math.max(0, num(it.cost));
        rec.qty = q;
        rec.value = q*c;
        rec.costQty = q;
        rec.nextExp = ""; // not tracked
      }
    }

    for(const rec of byItem.values()){
      if(rec.qty>0 || (db.items.length<=200)) rows.push(rec);
    }
    // sort by item name
    rows.sort((a,b)=> (a.item.name||"").localeCompare(b.item.name||""));
    return rows;
  }

  function renderInventory(){
    const rows = inventoryTotals();
    const q = ($("invSearch")?.value || "").trim().toLowerCase();
    const tbody = $("invTable").querySelector("tbody");
    tbody.innerHTML = "";

    // headers / labels
    $("invTitle").textContent = (lang==="es" ? "Inventario" : "Inventory");
    $("invHint").textContent = (lang==="es" ? "Totales de todas las entregas (lotes)." : "Totals across all deliveries (batches).");
    $("invSearch").placeholder = (lang==="es" ? "Buscar artículo..." : "Search item...");
    $("invThItem").textContent = (lang==="es" ? "Artículo" : "Item");
    $("invThQty").textContent = (lang==="es" ? "Cant. total" : "Total Qty");
    $("invThUnit").textContent = (lang==="es" ? "Unidad" : "Unit");
    $("invThAvgCost").textContent = (lang==="es" ? "Costo prom." : "Avg Cost");
    $("invThValue").textContent = (lang==="es" ? "Valor total" : "Total Value");
    $("invThNextExp").textContent = (lang==="es" ? "Próx. venc." : "Next Exp");

    let shown = 0;
    for(const r of rows){
      const name = (r.item.name||"");
      if(q && !name.toLowerCase().includes(q) && !(r.item.sku||"").toLowerCase().includes(q)) continue;

      const avg = r.costQty>0 ? (r.value / r.costQty) : 0;
      const tr = document.createElement("tr");

      // expiration status
      let expText = r.nextExp || "";
      let expBadge = "";
      if(expText){
        const days = daysUntil(expText);
        if(days < 0) expBadge = "bad";
        else if(days <= 3) expBadge = "warn";
        else expBadge = "good";
      }

      tr.innerHTML = `
        <td><div style="font-weight:700">${esc(name)}</div><div class="hint">${esc(r.item.sku||"")}</div></td>
        <td style="white-space:nowrap">${fmtQty(r.qty)} </td>
        <td>${esc(r.item.unit||"")}</td>
        <td style="white-space:nowrap">${money(avg)}</td>
        <td style="white-space:nowrap">${money(r.value)}</td>
        <td style="white-space:nowrap">${expText ? `<span class="pill ${expBadge}">${expText}</span>` : `<span class="hint">—</span>`}</td>
      `;
      tbody.appendChild(tr);
      shown++;
    }

    $("chipInv").textContent = shown;
  }

function renderSales(){
    const tb = $("salesTbody"); tb.innerHTML="";
    for(const s of db.sales.slice(0,250)){
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${esc(s.date)}</td>
        <td>${esc(s.itemName || (db.items.find(x=>x.id===s.itemId)?.name || ""))}</td>
        <td>${num(s.qty)}</td>
        <td>${money(s.price)}</td>
        <td>${money(s.revenue)}</td>
        <td>${money(s.cogs)}</td>
        <td>${money(s.profit)}</td>
        <td><button class="danger" data-id="${s.id}">${lang==="es"?"Borrar":"Delete"}</button></td>
      `;
      tb.appendChild(tr);
    }
    tb.onclick = (e)=>{
      const btn = e.target.closest("button[data-id]");
      if(!btn) return;
      const id = btn.dataset.id;
      if(!confirm(lang==="es"?"¿Borrar venta? (no revierte inventario)":"Delete sale? (does NOT restore inventory)")) return;
      db.sales = db.sales.filter(x=>x.id!==id);
      saveDB(); renderAll();
    };

    const tday = todayISO();
    const today = db.sales.filter(x=>x.date===tday);
    const rev = today.reduce((s,x)=>s+num(x.revenue),0);
    const prof = today.reduce((s,x)=>s+num(x.profit),0);
    $("salesTodayRevenue").textContent = money(rev);
    $("salesTodayProfit").textContent = (lang==="es"?"Ganancia hoy (est): ":"Today Profit (est): ") + money(prof);
  }

  // TVA
  $("saveTargetBtn").addEventListener("click", ()=>{
    const tday = todayISO();
    db.tvaTargetByDate[tday] = Math.max(0, num($("tvaTarget").value));
    saveDB(); renderAll();
  });

  // WASTE
  $("addWasteBtn").addEventListener("click", ()=>{
    const date = $("wDate").value || todayISO();
    const item = $("wItem").value.trim();
    const qty = Math.max(0, num($("wQty").value));
    const cost = Math.max(0, num($("wCost").value));
    const reason = $("wReason").value.trim();
    if(!item){ alert(lang==="es"?"Se requiere artículo.":"Waste item required."); return; }

    // If this waste item matches an inventory item, subtract it from batches/on-hand
    let loggedCost = cost;
    const invItem = db.items.find(x=>x.name.toLowerCase()===item.toLowerCase());
    if(invItem && qty>0){
      const have = availableQty(invItem.id);
      if(have < qty){
        alert(lang==="es"
          ? `No hay suficiente inventario para merma. En mano: ${have}`
          : `Not enough inventory for waste. On-hand: ${have}`);
        return;
      }
      const take = consumeFromBatches(invItem.id, qty);
      if(!take.ok){
        alert(lang==="es"?"No hay suficiente inventario.":"Not enough inventory.");
        return;
      }
      if(!(loggedCost>0)) loggedCost = take.totalCost;
    }

    db.waste.unshift({ id: uid(), date, item, qty, cost: loggedCost, reason });
    $("wItem").value=""; $("wQty").value=""; $("wCost").value=""; $("wReason").value="";
    saveDB(); renderAll();
  });

  // BACKUP
  $("exportBtn").addEventListener("click", ()=>{
    const blob = new Blob([JSON.stringify(db,null,2)], {type:"application/json"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "par-ops-backup.json";
    a.click();
    URL.revokeObjectURL(a.href);
  });
  $("importBtn").addEventListener("click", ()=> $("importFile").click());
  $("importFile").addEventListener("change",(e)=>{
    const file=e.target.files?.[0]; if(!file) return;
    const reader=new FileReader();
    reader.onload=()=>{
      try{ db = JSON.parse(reader.result); saveDB(); renderAll(); alert(lang==="es"?"Importado.":"Imported."); }
      catch{ alert(lang==="es"?"Falló la importación.":"Import failed."); }
    };
    reader.readAsText(file);
    e.target.value="";
  });
  $("wipeBtn").addEventListener("click", ()=>{
    if(!confirm(lang==="es"?"¿Borrar TODOS los datos?":"Wipe ALL data?")) return;
    db = defaultDB(); saveDB(); renderAll();
  });

  // CHARTS
  function groupDaily(log, valueKey){
    const map=new Map();
    for(const e of log){
      const d=e.date || todayISO();
      map.set(d, (map.get(d)||0) + num(e[valueKey]));
    }
    const days=[...map.keys()].sort();
    return { days, vals: days.map(d=>map.get(d)) };
  }

  function drawLine(canvas, labels, vals, yLabel, secondaryVals=null){
    const ctx=canvas.getContext("2d");
    const w=canvas.width, h=canvas.height;
    ctx.clearRect(0,0,w,h);

    const padL=44,padR=16,padT=12,padB=34;
    const plotW=w-padL-padR, plotH=h-padT-padB;

    if(vals.length===0){
      ctx.fillStyle="rgba(233,238,252,.7)";
      ctx.font="14px system-ui";
      ctx.fillText(lang==="es" ? "Sin datos aún." : "No data yet.", 18, 42);
      return;
    }

    const maxV=Math.max(1,...vals, ...(secondaryVals||[0]));
    ctx.strokeStyle="rgba(255,255,255,.08)";
    for(let i=0;i<=4;i++){
      const y=padT+plotH*(i/4);
      ctx.beginPath(); ctx.moveTo(padL,y); ctx.lineTo(padL+plotW,y); ctx.stroke();
    }

    ctx.fillStyle="rgba(233,238,252,.65)";
    ctx.font="12px system-ui";
    for(let i=0;i<=4;i++){
      const v=maxV-(maxV*(i/4));
      const y=padT+plotH*(i/4);
      ctx.fillText(v.toFixed(0), 8, y+4);
    }
    ctx.fillText(yLabel, 8, 12);

    function plot(values, stroke){
      ctx.strokeStyle=stroke; ctx.lineWidth=2;
      ctx.beginPath();
      values.forEach((v,i)=>{
        const x=padL + (values.length===1 ? plotW/2 : plotW*(i/(values.length-1)));
        const y=padT + plotH*(1-(v/maxV));
        if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
      });
      ctx.stroke();
    }

    plot(vals, "rgba(122,162,255,.95)");
    if(secondaryVals) plot(secondaryVals, "rgba(100,255,218,.85)");

    const step=Math.max(1, Math.floor(labels.length/6));
    ctx.fillStyle="rgba(233,238,252,.55)";
    for(let i=0;i<labels.length;i+=step){
      const x=padL + (labels.length===1 ? plotW/2 : plotW*(i/(labels.length-1)));
      ctx.fillText(labels[i].slice(5), x-16, h-12);
    }
  }

  function renderCharts(){
    const sales = groupDaily(db.sales, "revenue");
    drawLine($("chartSales"), sales.days, sales.vals, "$");
    drawLine($("chartSales2"), sales.days, sales.vals, "$");

    const tva = groupDaily(db.tvaLog, "tvaDollars");
    drawLine($("chartTva"), tva.days, tva.vals, "$");

    const waste = groupDaily(db.waste, "cost");
    drawLine($("chartWaste"), waste.days, waste.vals, "$");

    const targetVals = tva.days.map(d => num(db.tvaTargetByDate[d] || 0));
    drawLine($("chartTarget"), tva.days, tva.vals, "$", targetVals);
  }

  function renderDash(){
    const tday = todayISO();

    const salesToday = db.sales.filter(x=>x.date===tday);
    const rev = salesToday.reduce((s,x)=>s+num(x.revenue),0);
    const prof = salesToday.reduce((s,x)=>s+num(x.profit),0);
    $("kpiTodayRevenue").textContent = money(rev);
    $("kpiTodayProfit").textContent = (lang==="es"?"Ganancia hoy (est): ":"Today Profit (est): ") + money(prof);

    const tvaToday = db.tvaLog.filter(x=>x.date===tday);
    const missQty = tvaToday.reduce((s,x)=>s+num(x.missingQty),0);
    const tva$ = tvaToday.reduce((s,x)=>s+num(x.tvaDollars),0);
    $("kpiTodayTva").textContent = money(tva$);
    $("kpiTodayMissing").textContent = (lang==="es"?"Faltante: ":"Missing Qty: ") + missQty;

    $("chipToday").textContent = money(rev);
    $("chipItems").textContent = db.items.length;
    $("chipRcpt").textContent = db.receipts.length;
    $("chipSales").textContent = db.sales.length;
    $("chipTva").textContent = db.tvaLog.length;
    $("chipWaste").textContent = db.waste.length;
    // inventory chip = number of items shown in inventory table
    try{ $("chipInv").textContent = inventoryTotals().filter(r=>r.qty>0).length; }catch{}
  }

  function renderTva(){
    const tday = todayISO();
    const today = db.tvaLog.filter(x=>x.date===tday);
    const actual = today.reduce((s,x)=>s+num(x.tvaDollars),0);
    const target = num(db.tvaTargetByDate[tday] || 0);
    const variance = actual - target;
    const efficiency = actual === 0 ? 100 : Math.min(999, (target / actual) * 100);

    $("tvaActualKpi").textContent = money(actual);
    $("tvaTargetPill").textContent = `${lang==="es"?"Meta":"Target"}: ${money(target)}`;
    $("tvaVarPill").textContent = `${lang==="es"?"Variación":"Variance"}: ${money(variance)}`;
    $("tvaEffPill").textContent = `${lang==="es"?"Eficiencia":"Efficiency"}: ${efficiency.toFixed(0)}%`;
    $("tvaVarPill").className = "pill " + (variance <= 0 ? "ok" : "bad");
    $("tvaTarget").value = target || "";

    const tb = $("tvaTbody"); tb.innerHTML="";
    for(const e of db.tvaLog.slice(0,200)){
      const tr=document.createElement("tr");
      tr.innerHTML=`<td>${esc(e.date)}</td><td>${esc(e.code)}</td><td>${num(e.missingQty)}</td><td>${money(e.tvaDollars)}</td>`;
      tb.appendChild(tr);
    }
  }

  function renderWaste(){
    const tb=$("wasteTbody"); tb.innerHTML="";
    for(const w of db.waste.slice(0,200)){
      const tr=document.createElement("tr");
      tr.innerHTML = `
        <td>${esc(w.date)}</td><td>${esc(w.item)}</td><td>${num(w.qty)}</td><td>${money(w.cost)}</td><td>${esc(w.reason||"")}</td>
        <td><button class="danger" data-id="${w.id}">${lang==="es"?"Borrar":"Delete"}</button></td>`;
      tb.appendChild(tr);
    }
    tb.onclick=(e)=>{
      const btn=e.target.closest("button[data-id]"); if(!btn) return;
      const id=btn.dataset.id;
      if(!confirm(lang==="es"?"¿Borrar merma?":"Delete waste entry?")) return;
      db.waste = db.waste.filter(x=>x.id!==id);
      saveDB(); renderAll();
    };

    const tday=todayISO();
    const today = db.waste.filter(x=>x.date===tday);
    $("wasteToday").textContent = money(today.reduce((s,x)=>s+num(x.cost),0));
    $("wasteTodayQty").textContent = (lang==="es"?"Cant: ":"Qty: ") + today.reduce((s,x)=>s+num(x.qty),0);
  }

  function renderAll(){
    applyLang();
    renderItemSelects();
    renderItems();
    renderReceipt();
    renderInventory();
    renderSales();
    renderDash();
    renderTva();
    renderWaste();
    renderCharts();
  }

  // Init
  applyLang();
  renderAll();
</script>
</body>
</html>